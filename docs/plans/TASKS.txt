================================================================================
 📋 BOXY RSB COMPLIANCE - DETAILED TASK BREAKDOWN
================================================================================

Format: [TICKET-ID] Task Description (Story Points) - Priority
Story Point Scale: 1=Trivial, 2=Small, 3=Medium, 5=Large, 8=Complex, 13=Epic

================================================================================
 🎯 MILESTONE 1: BASIC MODULE RESTRUCTURING (23 pts) ✅ COMPLETED
================================================================================
Duration: COMPLETED | Risk: Low | No Breaking Changes
Status: 100% COMPLETE - All modules achieved 5/5 star ratings from China

Theme: Directory Structure Setup (8 pts)
----------------------------------------

[M1-002] Create src/colors/ directory and mod.rs (2) - High ✅ COMPLETED
  - ✅ Create colors/ directory
  - ✅ Move colors.rs functions to RSB MODULE_SPEC structure
  - ✅ Create mod.rs, utils.rs, helpers.rs files
  - ✅ Update imports throughout codebase
  - ✅ Verify compilation - All tests pass
  - ✅ China review: 5/5 stars - Perfect RSB compliance achieved

[M1-001] Create src/themes/ directory and mod.rs (2) - High ✅ COMPLETED
  - ✅ Create themes/ directory
  - ✅ Move themes.rs content to RSB MODULE_SPEC structure
  - ✅ Create mod.rs, utils.rs, helpers.rs files
  - ✅ Update imports in main.rs and lib.rs
  - ✅ Verify compilation - All tests pass
  - ✅ China review: 5/5 stars - Perfect RSB compliance achieved

[M1-003] Create src/visual/ directory and mod.rs (2) - High ✅ COMPLETED
  - ✅ Create visual/ directory
  - ✅ Move boxes.rs, components.rs, draw.rs to RSB MODULE_SPEC structure
  - ✅ Consolidate visual functionality with protected width macros
  - ✅ Update imports throughout codebase
  - ✅ China review: 5/5 stars - Perfect RSB compliance achieved

[M1-004] Create src/core/ directory and mod.rs (2) - High ✅ COMPLETED
  - ✅ Create core/ directory
  - ✅ Move config.rs, parser.rs, help.rs to RSB MODULE_SPEC structure
  - ✅ Handle remaining utility modules with protected icon detection
  - ✅ Update imports throughout codebase
  - ✅ China review: 5/5 stars - Perfect RSB compliance achieved

Theme: Re-export Compatibility Layer (8 pts)
--------------------------------------------
[M1-005] Update lib.rs re-exports for themes module (2) - High ✅ COMPLETED
  - ✅ Add pub use themes::* to maintain compatibility
  - ✅ Test all theme-related CLI functionality
  - ✅ Verify theme loading still works

[M1-006] Update lib.rs re-exports for colors module (2) - High ✅ COMPLETED
  - ✅ Add pub use colors::* to maintain compatibility
  - ✅ Test color functionality in CLI
  - ✅ Verify ANSI color codes work

[M1-007] Update lib.rs re-exports for visual module (2) - High ✅ COMPLETED
  - ✅ Add pub use visual::* to maintain compatibility
  - ✅ Test box drawing functionality
  - ✅ Verify component rendering

[M1-008] Update lib.rs re-exports for core module (2) - High ✅ COMPLETED
  - ✅ Add pub use core::* to maintain compatibility
  - ✅ Test configuration and parsing
  - ✅ Verify help system works

Theme: Integration Testing (5 pts)
----------------------------------
[M1-009] Full CLI regression testing (3) - Critical ✅ COMPLETED
  - ✅ Test all CLI commands with new structure
  - ✅ Verify theme loading, color application, box drawing
  - ✅ Performance benchmarking vs baseline - Zero regressions

[M1-010] Update internal imports across codebase (2) - Medium ✅ COMPLETED
  - ✅ Fix any remaining import issues
  - ✅ Ensure all modules can find dependencies
  - ✅ Clean up unused imports

[M1-011] Protect critical width/emoji functions during restructure (2) - Critical ✅ COMPLETED
  - ✅ Document exact locations of all protected functions
  - ✅ Ensure width_plugin.rs and emoji_debug.rs move as complete units
  - ✅ Preserve all width calculation macros exactly (max_width!, inner_target_width!)
  - ✅ Validate using: ./bin/test.sh && ./bin/feature-test.sh - All tests pass

================================================================================
 🎯 MILESTONE 1.5: AUTO/NONE PROPERTIES VALIDATION (8 pts) ✅ COMPLETED
================================================================================
Duration: COMPLETED | Risk: Low | Bug Fixes & Validation
Status: 100% COMPLETE - Comprehensive test suite with 66/66 tests passing

Theme: Text Color Auto/None Testing (3 pts)
-------------------------------------------
[M1.5-001] Test text_color="auto" behavior (2) - High ✅ COMPLETED
  - ✅ Verify "auto" matches box color in themes
  - ✅ Test with different box colors (red, blue, green, etc.)
  - ✅ Verify inheritance from parent themes with "auto"
  - ✅ Check builtin themes with "auto" text_color

[M1.5-002] Test text_color="none" behavior (1) - Medium ✅ COMPLETED
  - ✅ Verify "none" uses default terminal color
  - ✅ Test with different terminal color schemes
  - ✅ Ensure no ANSI codes when text_color="none"

Theme: Width Auto Testing (3 pts)
---------------------------------
[M1.5-003] Test width="auto" vs fixed width behavior (2) - High ✅ COMPLETED
  - ✅ Verify auto-sizing respects terminal width
  - ✅ Test with different terminal sizes
  - ✅ Check word wrapping with auto width
  - ✅ Validate padding calculations with auto width

[M1.5-004] Test width inheritance in themes (1) - Medium ✅ COMPLETED
  - ✅ Verify themes with width=None use auto-sizing
  - ✅ Test theme inheritance with mixed width settings
  - ✅ Check CLI --width=auto override behavior

Theme: Property Integration Testing (2 pts)
-------------------------------------------
[M1.5-005] Create comprehensive auto/none test suite (2) - Critical ✅ COMPLETED
  - ✅ Integration tests for all auto/none combinations
  - ✅ CLI tests with --text=auto, --text=none
  - ✅ Theme loading tests with auto/none properties
  - ✅ Regression tests to prevent future breaks
  - ✅ Full test suite passing: 66/66 tests including 8 new auto/none validation tests
  - ✅ Test file: tests/auto_none_properties_tests.rs

================================================================================
🎯 MILESTONE 1.7: RENDER TARGET STREAMING (15 pts) ✅ COMPLETED
================================================================================
Duration: 1 week | Risk: Medium | Performance infrastructure
Status: ✅ Completed – streaming path ready for library integration and benchmarks refreshed

Theme: Streaming Core (8 pts)
-----------------------------
[M1.7-001] Generalize RenderTarget to accept std::io::Write sinks (3) - Critical ✅ COMPLETED
  - Implement RenderTarget::from_writer / owned_writer lifecycle
  - Support fmt::Write + io::Write without extra allocations
  - Preserve existing render_to_string compatibility

[M1.7-002] Stream components into shared buffer (5) - High ✅ COMPLETED
  - Update Header/Body/Status/Footer to work with writer-backed targets
  - Ensure CLI draw path writes directly to stdout/tmux
  - Maintain temporary Vec adapters for downstream callers

Theme: Benchmarks & Regression Safety (7 pts)
---------------------------------------------
[M1.7-003] Refresh Criterion baselines for render_full bench (2) - Medium ✅ COMPLETED
  - Regenerate buffer-stream baseline after streaming change
  - Snapshot results via bin/snap.sh into meta/snaps/

[M1.7-004] Add snapshot tests for render_to_string outputs (3) - High ✅ COMPLETED
  - Added `tests/render_snapshots.rs` with fixture-backed golden output
  - Captures deterministic box render including current ANSI reset behavior
  - Prevents accidental string regressions during streaming follow-ups

[M1.7-005] Plan removal of temporary Vec<String> shims (1) - Medium ✅ COMPLETED
  - Documented adapters slated for removal (RenderTarget::new/into_lines, Body::render, Status::render)
  - Scheduled cleanup to land with M2 library API migration so downstream consumers have replacements

[M1.7-006] Document streaming API usage for library consumers (1) - High ✅ COMPLETED
  - Added streaming guidance to PUBLIC_API_STRAT (`Streaming directly into an arbitrary sink`)
  - Captured interim workflow using RenderTarget::from_writer and component render_into helpers
  - Will expand with BoxBuilder helpers during M2

================================================================================
 🎯 MILESTONE 2: LIBRARY API DEVELOPMENT (34 pts)
================================================================================
Duration: 2-3 weeks | Risk: Medium | New Public API

Theme: Core Library API Design (13 pts)
---------------------------------------
[M2-001] Design public API surface for box drawing (5) - Critical
  - Define BoxBuilder pattern for ergonomic usage
  - Create draw_box(), draw_text_box() functions
  - Design width/height/padding configuration
  - Plan async/sync variants

[M2-002] Design theme system public API (5) - Critical
  - Create ThemeLoader, ThemeApplicator traits
  - Design theme selection and validation functions
  - Plan theme customization and override API
  - Consider theme caching strategies

[M2-003] Design color system public API (3) - High
  - Create color parsing and manipulation functions
  - Design palette selection and validation
  - Plan ANSI code generation utilities
  - Consider color space conversions

Theme: Library Implementation (13 pts)
--------------------------------------
[M2-004] Implement BoxBuilder and drawing functions (5) - High
  - Create BoxBuilder with fluent interface
  - Implement core drawing logic for library usage
  - Handle text wrapping and width calculation
  - Add validation and error handling

[M2-005] Implement theme loading API (5) - High
  - Create theme loading from files/built-ins
  - Implement theme application to boxes
  - Add theme validation and error handling
  - Support custom theme definitions

[M2-006] Implement color manipulation utilities (3) - Medium
  - Create color parsing and validation functions
  - Implement ANSI code generation
  - Add color palette utilities
  - Support RGB/hex color inputs

Theme: Documentation & Examples (8 pts)
---------------------------------------
[M2-007] Create comprehensive library documentation (3) - High
  - Write rustdoc for all public APIs
  - Create usage examples for common patterns
  - Document theme system for library users
  - Add migration guide from CLI usage

[M2-008] Create library usage examples (3) - High
  - Basic box drawing example
  - Theme customization example
  - Color manipulation example
  - Integration with other CLI tools

[M2-009] Separate CLI and library concerns (2) - Medium
  - Move CLI-specific logic to main.rs
  - Ensure library has no CLI dependencies
  - Create clean separation of concerns
  - Test library usage without CLI

[M2-010] Refresh CLI help documentation (2) - Medium
  - Add height-related options (--height, `height` subcommand, `--params h=`) to --help output
  - Document streaming/RanderTarget guidance as part of help footer
  - Ensure CLI help reflects current theme/height features
  - Regenerate README/usage snippets after help update

================================================================================
 🎯 MILESTONE 3: UTILS/HELPERS SEPARATION (20 pts)
================================================================================
Duration: 1-2 weeks | Risk: Low | Internal Reorganization

Theme: Themes Module Separation (5 pts)
---------------------------------------
[M3-001] Create themes/utils.rs with public helpers (3) - High
  - Move load_theme(), validate_theme() to utils.rs
  - Move theme application functions to utils.rs
  - Ensure clean public interface

[M3-002] Create themes/helpers.rs with internal logic (2) - Medium
  - Move theme parsing internals to helpers.rs
  - Move YAML processing to helpers.rs
  - Keep implementation details private

[M3-009] Evaluate serde YAML replacement (2) - Medium
  - Investigate migration path from deprecated `serde_yaml 0.9` to the current community-supported crate (e.g. `serde_yml`)
  - Ensure theme serialization/deserialization APIs remain compatible
  - Update dependency tree and regression tests once replacement selected

[M3-010] Evaluate TOML vs JSON for theme storage (3) - High
  - Benchmark parse/serialize performance for representative theme sets
  - Compare ecosystem support (toml, serde_json, ron) and recommend default format
  - Decide on migration target (prefer TOML unless JSON yields material gains)

[M3-011] Migrate theme system to chosen format (5) - High
  - Implement new loader/saver using selected format
  - Provide backward-compatible YAML importer or one-shot conversion tool
  - Update documentation, examples, and tests to reflect new format
  - Drop deprecated serde_yaml dependency once migration completes

Theme: Colors Module Separation (4 pts)
---------------------------------------
[M3-003] Create colors/utils.rs with public helpers (2) - High
  - Move get_color_code(), validate_color() to utils.rs
  - Move ANSI generation functions to utils.rs

[M3-004] Create colors/helpers.rs with internal logic (2) - Medium
  - Move color parsing internals to helpers.rs
  - Move palette management to helpers.rs

Theme: Visual Module Separation (5 pts)
---------------------------------------
[M3-005] Create visual/utils.rs with public helpers (3) - High
  - Move draw_box(), calculate_width() to utils.rs
  - Move component rendering to utils.rs

[M3-006] Create visual/helpers.rs with internal logic (2) - Medium
  - Move internal width calculations to helpers.rs
  - Move box character selection to helpers.rs

Theme: Core Module Separation (4 pts)
-------------------------------------
[M3-007] Create core/utils.rs with public helpers (2) - High
  - Move configuration utilities to utils.rs
  - Move argument parsing helpers to utils.rs

[M3-008] Create core/helpers.rs with internal logic (2) - Medium
  - Move internal parsing logic to helpers.rs
  - Move configuration merging to helpers.rs

================================================================================
 🎯 MILESTONE 4: TYPED ERROR SYSTEM (16 pts)
================================================================================
Duration: 1-2 weeks | Risk: Medium | Error Handling Changes

Theme: Error Type Definition (8 pts)
------------------------------------
[M4-001] Create core/error.rs with BoxyError master enum (3) - Critical
  - Define BoxyError with variants for each module
  - Add thiserror derive and proper error messages
  - Include source error chaining

[M4-002] Create module-specific error types (5) - High
  - ThemeError in themes/error.rs
  - ColorError in colors/error.rs
  - VisualError in visual/error.rs
  - CoreError in core/error.rs

Theme: Error Migration (8 pts)
------------------------------
[M4-003] Replace String errors in themes module (3) - High
  - Update all Result<T, String> to Result<T, ThemeError>
  - Add proper error variants for theme operations
  - Update error propagation

[M4-004] Replace String errors in colors module (2) - High
  - Update color operations to use ColorError
  - Add proper error variants

[M4-005] Replace String errors in visual module (2) - High
  - Update drawing operations to use VisualError
  - Add proper error variants

[M4-006] Replace String errors in core module (1) - Medium
  - Update configuration and parsing errors
  - Ensure proper error propagation to CLI

================================================================================
 🎯 MILESTONE 5: FEATURE FLAGS & ADAPTERS (28 pts)
================================================================================
Duration: 2-3 weeks | Risk: High | Complex Feature Interactions

Theme: Feature Flag Design (8 pts)
----------------------------------
[M5-001] Design Cargo.toml feature hierarchy (5) - Critical
  - Define visual-base, visual-advanced features
  - Define colors-simple, colors-named features
  - Define themes-builtin, themes-yaml features
  - Plan default feature set

[M5-002] Implement conditional compilation (3) - High
  - Add #[cfg(feature = "...")] throughout codebase
  - Ensure graceful degradation when features disabled
  - Test feature combinations

[M5-002a] Gate height system behind cargo feature (2) - High
  - Introduce default-on `height` feature in Cargo.toml
  - Wrap height_plugin, CLI flags, and BOXY_MULTIPLEX_MODE logic in #[cfg(feature = "height")]
  - Provide no-op stubs when feature disabled to keep API compiling
  - Document build instructions for height-enabled vs minimal builds

Theme: Adapter Pattern Implementation (12 pts)
----------------------------------------------
[M5-003] Create themes/adapters.rs for color integration (5) - High
  - Implement ColorAdapter for theme → color operations
  - Add feature gating for color dependencies
  - Provide fallbacks when colors disabled

[M5-004] Create visual/adapters.rs for theme integration (5) - High
  - Implement ThemeAdapter for visual → theme operations
  - Add feature gating for theme dependencies
  - Provide fallbacks when themes disabled

[M5-005] Create cross-module dependency injection (2) - Medium
  - Design service locator pattern if needed
  - Implement dependency injection for adapters
  - Ensure testability

Theme: Feature Testing (8 pts)
------------------------------
[M5-006] Test all feature flag combinations (5) - Critical
  - Create CI matrix for feature combinations
  - Test minimal builds with reduced features
  - Verify no compilation errors

[M5-007] Performance testing with different features (3) - Medium
  - Benchmark performance with minimal features
  - Ensure no overhead when features disabled
  - Validate binary size reduction

================================================================================
 🎯 MILESTONE 6: CURATED PRELUDE & MACROS (14 pts)
================================================================================
Duration: 1-2 weeks | Risk: Medium | Public API Changes

Theme: Prelude Curation (8 pts)
-------------------------------
[M6-001] Remove wildcard re-exports from lib.rs (5) - Critical
  - Replace pub use module::* with specific exports
  - Define intentional public API surface
  - Ensure backward compatibility via explicit exports

[M6-002] Implement ASCII-first naming conventions (3) - Medium
  - Audit public API for non-ASCII names
  - Provide ASCII alternatives where needed
  - Document Unicode variants

Theme: Macro System (6 pts)
---------------------------
[M6-003] Create module-owned macros (3) - Medium
  - Add macros.rs to each module as needed
  - Implement ergonomic macros for common operations
  - Ensure macros follow RSB patterns

[M6-004] Final RSB MODULE_SPEC compliance validation (3) - High
  - Audit entire codebase against RSB MODULE_SPEC
  - Fix any remaining compliance issues
  - Document compliance status

================================================================================
 🎯 MILESTONE HEIGHT: TERMINAL HEIGHT SYSTEM (18 pts) ✅ COMPLETED
================================================================================
Duration: 1-2 weeks | Risk: Medium | New Terminal Feature
Status: ✅ Completed – height flag, params, diagnostics and padding logic landed

Theme: Height Plugin Foundation (8 pts)
--------------------------------------
[MH-001] Create src/height_plugin.rs following width_plugin.rs patterns (3) - Critical ✅ COMPLETED
  - height_plugin.rs mirrors width plugin structure with `get_terminal_height`, fallbacks, and validation helper

[MH-002] Add height diagnostics subcommand (2) - High ✅ COMPLETED
  - `boxy height` implemented via `handle_height_command()` in main.rs
  - CLI help to be refreshed under `[M2-010]` to surface the command

[MH-003] Integrate height detection in lib.rs and modules (3) - High ✅ COMPLETED
  - Height helpers exported from lib.rs; visual/core modules consume them for padding logic

Theme: CLI Height Integration (5 pts)
-------------------------------------
[MH-004] Add --height flag to CLI argument parsing (2) - Critical ✅ COMPLETED
  - `--height <N|max|auto>` handled in main.rs with validation + `get_max_safe_height`

[MH-005] Extend --params flag to support h=N syntax (3) - High ✅ COMPLETED
  - `parse_content_stream` accepts `h=...` and maps into `ParsedContent.height`

Theme: Height Layout Engine (5 pts)
-----------------------------------
[MH-006] Implement height padding in visual system (3) - Critical ✅ COMPLETED
  - Visual utils insert padding lines to honour fixed height while keeping status anchored

[MH-007] Add height mode support (pad/truncate/auto) (2) - Medium ✅ COMPLETED
  - HeightMode enum active; pad/truncate/auto options wired through CLI/env and visual padding logic

### CRITICAL FUNCTION PROTECTION TASKS (Added to All Milestones):

[MX-P01] Width calculation protection validation (1) - Critical
  - Test emoji width calculations before/after changes
  - Validate: echo "✅🚀ℹ️👻" | cargo run -- --theme test
  - Run: ./bin/test.sh && ./bin/feature-test.sh

[MX-P02] Icon placement protection validation (1) - Critical
  - Test icon auto-detection and spacing
  - Validate: echo "test" | cargo run -- --title "📦 Status"
  - Ensure parser.rs:385-410 logic preserved exactly

[MX-P03] Performance regression protection (1) - Critical
  - Benchmark width calculations before/after
  - No performance degradation in emoji rendering
  - Run: ./tests/misc/performance_test.sh

================================================================================
 📊 TASK SUMMARY BY MILESTONE
================================================================================

M1 (23 pts): 11 tasks + 3 protection - Basic module restructuring ✅ COMPLETED
M1.5 (8 pts): 5 tasks - Auto/None properties validation ✅ COMPLETED
M1.7 (15 pts): 6 tasks - Render target streaming & benchmarks ✅ COMPLETED
MH (18 pts): 7 tasks - Terminal height system ⬆️ NEXT
M2 (34 pts): 9 tasks - Library API development
M3 (18 pts): 8 tasks - Utils/helpers separation
M4 (16 pts): 6 tasks - Typed error system
M5 (28 pts): 7 tasks - Feature flags & adapters
M6 (14 pts): 4 tasks - Curated prelude & macros

Completed: 46 story points (M1 + M1.5 + M1.7)
Remaining: 128 story points across 44 tasks
Total: 174 story points across 62 tasks

================================================================================
 🎯 TASK PRIORITIZATION
================================================================================

Critical Path Tasks (Must complete first):
- M1-001 through M1-008: Module structure setup
- M2-001, M2-002: API design (blocks implementation)
- M4-001: Master error enum (blocks error migration)
- M5-001: Feature flag design (blocks implementation)
- M6-001: Prelude curation (final API surface)

High Risk Tasks (Need extra attention):
- M2-001: Public API design (affects all future work)
- M5-001: Feature flag hierarchy (complex interactions)
- M5-006: Feature combination testing (high complexity)
- M6-001: Wildcard removal (potential breaking changes)

Dependencies:
- M3 depends on M1 completion
- M4 can run parallel to M3
- M5 depends on M1-M4 completion
- M6 depends on all previous milestones

================================================================================
